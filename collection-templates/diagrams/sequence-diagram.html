<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{BRAND_NAME}} Event-Verarbeitung Sequenz</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:{{BG}};font-family:system-ui,-apple-system,sans-serif;color:{{TEXT}};min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:40px 20px}
  h1{font-size:2rem;font-weight:700;letter-spacing:-.5px;margin-bottom:8px}
  h1 span{color:{{PRIMARY}}}
  .subtitle{color:{{MUTED}};font-size:.95rem;margin-bottom:32px}
  .diagram-wrap{background:#1e293b;border-radius:16px;border:1px solid rgba({{PRIMARY_RGB}},.15);padding:32px;max-width:1200px;width:100%;overflow-x:auto}
  svg text{font-family:system-ui,-apple-system,sans-serif}

  @keyframes dashFlow{to{stroke-dashoffset:-16}}
  .animated-arrow{stroke-dasharray:6 2;animation:dashFlow .6s linear infinite}
</style>
</head>
<body>

<h1><span>{{BRAND_NAME}}</span> Event-Verarbeitung Sequenz</h1>
<p class="subtitle">Sequenzdiagramm &mdash; Vollständiger Ablauf der Event-Verarbeitung von Eingang bis Benachrichtigung</p>

<div class="diagram-wrap">
<svg viewBox="0 0 1100 920" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto">
  <defs>
    <marker id="ar" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="{{PRIMARY}}"/>
    </marker>
    <marker id="ar-ret" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto">
      <polygon points="8 0,0 3,8 6" fill="{{PRIMARY_DARK}}"/>
    </marker>
    <marker id="ar-blue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="{{INFO}}"/>
    </marker>
    <marker id="ar-purple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="#a78bfa"/>
    </marker>
    <marker id="ar-green" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="{{SUCCESS}}"/>
    </marker>
    <marker id="ar-warn" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="{{WARNING}}"/>
    </marker>
    <marker id="ar-ret-p" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto">
      <polygon points="8 0,0 3,8 6" fill="#a78bfa"/>
    </marker>
  </defs>

  <!-- Column positions: 100, 280, 460, 640, 820, 1000 -->

  <!-- ========= ALTERNATING BACKGROUND BANDS ========= -->
  <rect x="0" y="100" width="1100" height="60" fill="{{BG}}" opacity=".3"/>
  <rect x="0" y="220" width="1100" height="60" fill="{{BG}}" opacity=".3"/>
  <rect x="0" y="340" width="1100" height="60" fill="{{BG}}" opacity=".3"/>
  <rect x="0" y="460" width="1100" height="100" fill="{{BG}}" opacity=".2"/>
  <rect x="0" y="620" width="1100" height="60" fill="{{BG}}" opacity=".3"/>
  <rect x="0" y="740" width="1100" height="60" fill="{{BG}}" opacity=".3"/>

  <!-- ========= PARTICIPANT HEADERS ========= -->
  <!-- Client -->
  <g>
    <rect x="40" y="10" width="120" height="50" rx="10" fill="{{SURFACE}}" stroke="{{INFO}}" stroke-width="1.5"/>
    <text x="100" y="32" text-anchor="middle" fill="{{INFO}}" font-size="10" font-weight="600">CLIENT</text>
    <text x="100" y="48" text-anchor="middle" fill="{{TEXT}}" font-size="12" font-weight="700">React App</text>
  </g>
  <!-- API -->
  <g>
    <rect x="220" y="10" width="120" height="50" rx="10" fill="#1a3a3a" stroke="{{PRIMARY}}" stroke-width="1.5"/>
    <text x="280" y="32" text-anchor="middle" fill="{{PRIMARY}}" font-size="10" font-weight="600">API</text>
    <text x="280" y="48" text-anchor="middle" fill="{{TEXT}}" font-size="12" font-weight="700">Express</text>
  </g>
  <!-- EventStore -->
  <g>
    <rect x="400" y="10" width="120" height="50" rx="10" fill="#1a3a2a" stroke="{{SUCCESS}}" stroke-width="1.5"/>
    <text x="460" y="32" text-anchor="middle" fill="{{SUCCESS}}" font-size="10" font-weight="600">STORE</text>
    <text x="460" y="48" text-anchor="middle" fill="{{TEXT}}" font-size="12" font-weight="700">EventStore</text>
  </g>
  <!-- AIEngine -->
  <g>
    <rect x="580" y="10" width="120" height="50" rx="10" fill="#2a1a3a" stroke="#a78bfa" stroke-width="1.5"/>
    <text x="640" y="32" text-anchor="middle" fill="#a78bfa" font-size="10" font-weight="600">KI</text>
    <text x="640" y="48" text-anchor="middle" fill="{{TEXT}}" font-size="12" font-weight="700">AI Engine</text>
  </g>
  <!-- WebhookService -->
  <g>
    <rect x="760" y="10" width="120" height="50" rx="10" fill="#2a2a1a" stroke="{{WARNING}}" stroke-width="1.5"/>
    <text x="820" y="32" text-anchor="middle" fill="{{WARNING}}" font-size="10" font-weight="600">WEBHOOK</text>
    <text x="820" y="48" text-anchor="middle" fill="{{TEXT}}" font-size="11" font-weight="700">Dispatcher</text>
  </g>
  <!-- TelegramBot -->
  <g>
    <rect x="940" y="10" width="120" height="50" rx="10" fill="#1a3a3a" stroke="{{PRIMARY}}" stroke-width="1.5"/>
    <text x="1000" y="32" text-anchor="middle" fill="{{PRIMARY}}" font-size="10" font-weight="600">BOT</text>
    <text x="1000" y="48" text-anchor="middle" fill="{{TEXT}}" font-size="12" font-weight="700">grammY</text>
  </g>

  <!-- ========= LIFELINES ========= -->
  <line x1="100" y1="60" x2="100" y2="890" stroke="{{INFO}}" stroke-width="1" stroke-dasharray="4 3" opacity=".4"/>
  <line x1="280" y1="60" x2="280" y2="890" stroke="{{PRIMARY}}" stroke-width="1" stroke-dasharray="4 3" opacity=".4"/>
  <line x1="460" y1="60" x2="460" y2="890" stroke="{{SUCCESS}}" stroke-width="1" stroke-dasharray="4 3" opacity=".4"/>
  <line x1="640" y1="60" x2="640" y2="890" stroke="#a78bfa" stroke-width="1" stroke-dasharray="4 3" opacity=".4"/>
  <line x1="820" y1="60" x2="820" y2="890" stroke="{{WARNING}}" stroke-width="1" stroke-dasharray="4 3" opacity=".4"/>
  <line x1="1000" y1="60" x2="1000" y2="890" stroke="{{PRIMARY}}" stroke-width="1" stroke-dasharray="4 3" opacity=".4"/>

  <!-- ========= ACTIVATION BARS ========= -->
  <!-- Client activation -->
  <rect x="95" y="100" width="10" height="220" rx="2" fill="{{INFO}}" opacity=".3"/>
  <!-- API activation -->
  <rect x="275" y="110" width="10" height="320" rx="2" fill="{{PRIMARY}}" opacity=".3"/>
  <!-- EventStore activation -->
  <rect x="455" y="180" width="10" height="80" rx="2" fill="{{SUCCESS}}" opacity=".3"/>
  <!-- AI activation (async) -->
  <rect x="635" y="470" width="10" height="170" rx="2" fill="#a78bfa" opacity=".3"/>
  <!-- Webhook activation -->
  <rect x="815" y="660" width="10" height="90" rx="2" fill="{{WARNING}}" opacity=".3"/>
  <!-- Telegram activation -->
  <rect x="995" y="770" width="10" height="70" rx="2" fill="{{PRIMARY}}" opacity=".3"/>

  <!-- ========= SEQUENCE MESSAGES ========= -->

  <!-- 1. Client -> API: POST /events -->
  <line x1="105" y1="120" x2="272" y2="120" stroke="{{INFO}}" stroke-width="2" marker-end="url(#ar)"/>
  <rect x="120" y="102" width="140" height="18" rx="4" fill="{{BG}}" stroke="#334155" stroke-width=".5"/>
  <text x="190" y="114" text-anchor="middle" fill="{{INFO}}" font-size="10" font-weight="600">POST /events</text>
  <text x="112" y="98" fill="{{MUTED}}" font-size="8">1</text>

  <!-- 2. API: validate (self-message) -->
  <path d="M285,160 Q340,160 340,175 Q340,190 285,190" fill="none" stroke="{{PRIMARY}}" stroke-width="1.5" marker-end="url(#ar)"/>
  <text x="348" y="178" fill="{{PRIMARY}}" font-size="10">validieren()</text>
  <text x="288" y="155" fill="{{MUTED}}" font-size="8">2</text>

  <!-- 3. API -> EventStore: append(event) -->
  <line x1="285" y1="220" x2="452" y2="220" stroke="{{SUCCESS}}" stroke-width="2" marker-end="url(#ar-green)"/>
  <rect x="310" y="205" width="110" height="16" rx="4" fill="{{BG}}" stroke="#334155" stroke-width=".5"/>
  <text x="365" y="216" text-anchor="middle" fill="{{SUCCESS}}" font-size="10" font-weight="600">append(event)</text>
  <text x="288" y="215" fill="{{MUTED}}" font-size="8">3</text>

  <!-- 4. EventStore -> API: { stored: true, id } -->
  <line x1="452" y1="250" x2="285" y2="250" stroke="{{SUCCESS}}" stroke-width="1.5" stroke-dasharray="4 2" marker-end="url(#ar-ret)"/>
  <text x="365" y="245" text-anchor="middle" fill="{{MUTED}}" font-size="10">{ stored: true, id }</text>
  <text x="455" y="245" fill="{{MUTED}}" font-size="8">4</text>

  <!-- 5. API -> Client: 201 Created -->
  <line x1="275" y1="300" x2="105" y2="300" stroke="{{PRIMARY}}" stroke-width="1.5" stroke-dasharray="4 2" marker-end="url(#ar-ret)"/>
  <rect x="120" y="285" width="130" height="16" rx="4" fill="{{BG}}" stroke="#334155" stroke-width=".5"/>
  <text x="185" y="296" text-anchor="middle" fill="{{PRIMARY}}" font-size="10" font-weight="600">201 Created + id</text>
  <text x="277" y="295" fill="{{MUTED}}" font-size="8">5</text>

  <!-- Async boundary -->
  <rect x="20" y="370" width="1060" height="28" rx="6" fill="#a78bfa" opacity=".08" stroke="#a78bfa" stroke-width="1" stroke-dasharray="6 3"/>
  <text x="550" y="388" text-anchor="middle" fill="#a78bfa" font-size="11" font-weight="600" letter-spacing="2">ASYNCHRON</text>

  <!-- 6. API -> EventStore: getStream(id) -->
  <line x1="285" y1="420" x2="452" y2="420" stroke="{{PRIMARY}}" stroke-width="1.5" marker-end="url(#ar)"/>
  <text x="365" y="415" text-anchor="middle" fill="{{MUTED}}" font-size="10">getStream(id)</text>
  <text x="288" y="415" fill="{{MUTED}}" font-size="8">6</text>

  <!-- 7. API -> AI: analyze(event) -->
  <line x1="285" y1="480" x2="632" y2="480" stroke="#a78bfa" stroke-width="2" marker-end="url(#ar-purple)"/>
  <rect x="380" y="465" width="160" height="16" rx="4" fill="{{BG}}" stroke="#334155" stroke-width=".5"/>
  <text x="460" y="476" text-anchor="middle" fill="#a78bfa" font-size="10" font-weight="600">analyze(event, context)</text>
  <text x="288" y="475" fill="{{MUTED}}" font-size="8">7</text>

  <!-- 8. AI: process (self) -->
  <path d="M645,520 Q700,520 700,535 Q700,550 645,550" fill="none" stroke="#a78bfa" stroke-width="1.5" marker-end="url(#ar-purple)"/>
  <text x="710" y="538" fill="#a78bfa" font-size="10">KI-Verarbeitung</text>
  <text x="648" y="515" fill="{{MUTED}}" font-size="8">8</text>

  <!-- 9. AI -> EventStore: store result -->
  <line x1="640" y1="580" x2="465" y2="580" stroke="{{SUCCESS}}" stroke-width="1.5" marker-end="url(#ar-ret)"/>
  <text x="550" y="575" text-anchor="middle" fill="{{MUTED}}" font-size="10">storeResult(analysis)</text>
  <text x="637" y="575" fill="{{MUTED}}" font-size="8">9</text>

  <!-- 10. AI -> API: analysis complete -->
  <line x1="635" y1="620" x2="285" y2="620" stroke="#a78bfa" stroke-width="1.5" stroke-dasharray="4 2" marker-end="url(#ar-ret-p)"/>
  <text x="460" y="615" text-anchor="middle" fill="#a78bfa" font-size="10">{ analysis: result }</text>
  <text x="637" y="615" fill="{{MUTED}}" font-size="8">10</text>

  <!-- 11. API -> Webhook: dispatch(event) -->
  <line x1="285" y1="670" x2="812" y2="670" stroke="{{WARNING}}" stroke-width="2" marker-end="url(#ar-warn)"/>
  <rect x="470" y="655" width="160" height="16" rx="4" fill="{{BG}}" stroke="#334155" stroke-width=".5"/>
  <text x="550" y="666" text-anchor="middle" fill="{{WARNING}}" font-size="10" font-weight="600">dispatch(event, targets)</text>
  <text x="288" y="665" fill="{{MUTED}}" font-size="8">11</text>

  <!-- 12. Webhook: deliver (self) -->
  <path d="M825,700 Q880,700 880,715 Q880,730 825,730" fill="none" stroke="{{WARNING}}" stroke-width="1.5" marker-end="url(#ar-warn)"/>
  <text x="890" y="718" fill="{{WARNING}}" font-size="10">HTTP POST an Ziele</text>
  <text x="828" y="695" fill="{{MUTED}}" font-size="8">12</text>

  <!-- 13. API -> Telegram: notify(event) -->
  <line x1="285" y1="780" x2="992" y2="780" stroke="{{PRIMARY}}" stroke-width="2" marker-end="url(#ar)"/>
  <rect x="550" y="765" width="180" height="16" rx="4" fill="{{BG}}" stroke="#334155" stroke-width=".5"/>
  <text x="640" y="776" text-anchor="middle" fill="{{PRIMARY}}" font-size="10" font-weight="600">sendNotification(event, chats)</text>
  <text x="288" y="775" fill="{{MUTED}}" font-size="8">13</text>

  <!-- 14. Telegram: send (self) -->
  <path d="M1005,810 Q1060,810 1060,822 Q1060,834 1005,834" fill="none" stroke="{{PRIMARY}}" stroke-width="1.5" marker-end="url(#ar)"/>
  <text x="1070" y="825" fill="{{PRIMARY}}" font-size="10">Bot API senden</text>
  <text x="1008" y="806" fill="{{MUTED}}" font-size="8">14</text>

  <!-- ========= FOOTER PARTICIPANTS (mirror) ========= -->
  <g transform="translate(0,850)">
    <rect x="40" y="10" width="120" height="36" rx="8" fill="{{SURFACE}}" stroke="{{INFO}}" stroke-width="1"/>
    <text x="100" y="33" text-anchor="middle" fill="{{TEXT}}" font-size="11" font-weight="600">React App</text>
  </g>
  <g transform="translate(0,850)">
    <rect x="220" y="10" width="120" height="36" rx="8" fill="#1a3a3a" stroke="{{PRIMARY}}" stroke-width="1"/>
    <text x="280" y="33" text-anchor="middle" fill="{{TEXT}}" font-size="11" font-weight="600">Express</text>
  </g>
  <g transform="translate(0,850)">
    <rect x="400" y="10" width="120" height="36" rx="8" fill="#1a3a2a" stroke="{{SUCCESS}}" stroke-width="1"/>
    <text x="460" y="33" text-anchor="middle" fill="{{TEXT}}" font-size="11" font-weight="600">EventStore</text>
  </g>
  <g transform="translate(0,850)">
    <rect x="580" y="10" width="120" height="36" rx="8" fill="#2a1a3a" stroke="#a78bfa" stroke-width="1"/>
    <text x="640" y="33" text-anchor="middle" fill="{{TEXT}}" font-size="11" font-weight="600">AI Engine</text>
  </g>
  <g transform="translate(0,850)">
    <rect x="760" y="10" width="120" height="36" rx="8" fill="#2a2a1a" stroke="{{WARNING}}" stroke-width="1"/>
    <text x="820" y="33" text-anchor="middle" fill="{{TEXT}}" font-size="11" font-weight="600">Dispatcher</text>
  </g>
  <g transform="translate(0,850)">
    <rect x="940" y="10" width="120" height="36" rx="8" fill="#1a3a3a" stroke="{{PRIMARY}}" stroke-width="1"/>
    <text x="1000" y="33" text-anchor="middle" fill="{{TEXT}}" font-size="11" font-weight="600">grammY</text>
  </g>

  <!-- Time annotations on right side -->
  <text x="15" y="120" fill="{{MUTED}}" font-size="9" font-style="italic">t₀</text>
  <text x="15" y="300" fill="{{MUTED}}" font-size="9" font-style="italic">t₁ ~50ms</text>
  <text x="15" y="480" fill="{{MUTED}}" font-size="9" font-style="italic">t₂ async</text>
  <text x="15" y="670" fill="{{MUTED}}" font-size="9" font-style="italic">t₃ ~2s</text>
  <text x="15" y="780" fill="{{MUTED}}" font-size="9" font-style="italic">t₄ ~3s</text>

</svg>
</div>

</body>
</html>
